<!doctype html>
<html>
    <head>
        <title>leaflet choropleth</title>

        <link rel="stylesheet" href="./static/lib/css/dc.css">
        <link rel="stylesheet" href="./static/lib/css/leaflet.css">
        <link rel="stylesheet" href="./static/lib/css/dc-leaflet-legend.css">
        <link rel="stylesheet" href="./static/lib/css/bootstrap.min.css">

        <script src="./static/lib/js/d3.min.js"></script>
        <script src="./static/lib/js/crossfilter.js"></script>
        <script src="./static/lib/js/crossfilter.min.js"></script>
        <script src="./static/lib/js/dc.js"></script>
        <script src="./static/lib/js/leaflet.js"></script>

        <script src="./static/lib/js/dc-leaflet.js"></script>

    </head>
    <body>
    <div class = "container-fluid cont-1">
        <div class = "row">
            <div class = "col-lg-12">
                
                <div class = "col-lg-2">
			</br>
			</br>
			</br>
				
			Choose Day:
			</br>
				<select id ="weekday"> 
					<option value ="Sun" selected>Sunday</option>
					<option value ="Mon">Monday</option>
					<option value ="Tues">Tuesday</option>
					<option value ="Wed">Wednesday</option>
					<option value ="Thurs">Thursday</option>
					<option value ="Fri">Friday</option>
					<option value ="Sat">Saturday</option>
				</select>
			</br>
			</br>
			</br>Choose Time Frame:
			</br>
				<select id ="hour"> 
					<option value ="00:00 to 03:00 am" selected>00:00 to 03:00 am</option>
					<option value ="03:01 to 06:00 am">03:01 to 06:00 am</option>
					<option value ="06:01 to 09:00 am">06:01 to 09:00 am</option>
					<option value ="09:01 to 12:00 nn">09:01 to 12:00 nn</option>
					<option value ="12:01 to 03:00 pm">12:01 to 03:00 pm</option>
					<option value ="03:01 to 06:00 pm">03:01 to 06:00 pm</option>
					<option value ="06:01 to 09:00 pm">06:01 to 09:00 pm</option>
					<option value ="09:01 to 00:00 pm">09:01 to 00:00 pm</option>
				</select>
			</br>
			</br>			
			</br>
			</br>
			<button type="button" onclick=viz() style = "{align-items: center;}">Visualize!</button>
			</br>
			</br>
			</br>
            <p style= "{text-align: center}">Prioritize deployment of additional <strong><span id ="numCars"></span></strong> cars in <strong><span id ="toplocation"></span> </strong>to earn additional <strong>Php <span id ="totallost"></span></strong>
			</p>
			</div>
			</br>
			</br>
                
                <div class = "col-lg-10">
				<div id="Choropleth-Chart" style="width:40%; height:550px;">
					<a class="reset" href="javascript:ChoroplethChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
					<span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>
				</div>
                </div>
                
                
            </div>
        </div>
    </div>
       <script>
		 // Add and count values of a column
        function reduceAdd(state, attr) {
            return function(p,v) {
                    ++p.count
					if(v[state] != "UNALLOCATED") {
						++p.count2;
						p.sums += v[attr];
						
						if(v[state] != "CANCELLED")
							++p.count3;
						}
                return p;
            };
        }
        function reduceRemove(state, attr) {
            return function(p,v) {
                    --p.count
					if(v[state] != "UNALLOCATED") {
						--p.count2;
						p.sums -= v[attr];
						}
						if(v[state] != "CANCELLED")
							--p.count3;
                return p;
            };
        }

		function reduceInit() {
          return {count:0, count2:0, count3:0, sums :0};
        };
						
        var numberFormat = d3.format(".2f"),
			numberFormat2 = d3.format(",");
			
		var ChoroplethChart = dc.leafletChoroplethChart("#Choropleth-Chart");
           d3.csv("data/leafletChoroplethChart.csv", function (csv) {
                var data = crossfilter(csv);

                var weekday = data.dimension(function (d) {
                    return d["weekday"];
                });
                var timeframe = data.dimension(function (d) {
                    return d["timeframe"];
                });
                var alldim = data.dimension(function(d){return d;});

				var states = data.dimension(function (d) {
                    return d["pick_up_location"];
                });
                var stateRaisedSum = states.group().reduce(reduceAdd("state", "fare"), reduceRemove("state","fare"), reduceInit);
                var stateRaisedSum2 = states.group().reduce(reduceAdd("state", "fare"), reduceRemove("state","fare"), reduceInit);

		function viz() {
			var weekday = document.getElementById("weekday").value
			var hour = document.getElementById("hour").value
			alldim.filter(function(d){return d.weekday == weekday & d.timeframe == hour}); 
			insights()
			
			ChoroplethChart
				.calculateColorDomain([0,150000])
				.redraw()
		}
			
      d3.json("data/MMMuniCities.json", function (MMMuniCities) {                    

			var weekday = document.getElementById("weekday").value
			var hour = document.getElementById("hour").value
			alldim.filter(function(d){return d.weekday == weekday & d.timeframe == hour}); 

		ChoroplethChart
            .width(800)
            .height(800)
            .center([14.54, 121.04])
            .zoom(11)
            .dimension(states)
            .group(stateRaisedSum)
			.colors(["#FFFFE5", "#F7FCB9", "#D9F0A3", "#ADDD8E", "#78C679", "#41AB5D", "#238443", "#006837", "#004529"])
			.colorAccessor(function(d) {return (d.value.count-d.value.count3)*(d.value.sums/d.value.count2);})
			.calculateColorDomain([0,150000])
            .geojson(MMMuniCities.features)
            .featureKeyAccessor(function(feature) {
				return feature.properties.NAME_2;
                        })
                        .title(function (d) {
							unmet = d.value.count-d.value.count3
							average = d.value.sums/d.value.count2
							total_lost = unmet*average
                            return "Location: " + d.key + "\n\n Total Unmet Demand: " + numberFormat2(unmet ? unmet : 0) + 
							"\n\n Average Fare: " + numberFormat(average ? average : 0) + "\n Total Lost Opportunity: " + numberFormat(total_lost ? total_lost : 0);
                        })
                        .legend(dc.leafletLegend().position('bottomright'));

                    dc.renderAll();
		function insights() {
			var max = 0,
				loc = "Cebu",
				average =0,
				total_lost = 0;
			for (let re of stateRaisedSum2.top(Infinity)){
				count1 = re.value.count
				count2 = re.value.count3
				diff = count1-count2
				average = re.value.sums/re.value.count2
				console.log(re.value.sums + ", " + re.value.count2 + ", " + average	)
				lost = diff*average
				if (lost > total_lost) {
					max = diff;
					loc = re.key;
					total_lost = numberFormat(lost);
					}
				}

			document.getElementById("numCars").innerHTML = max;
			document.getElementById("toplocation").innerHTML = loc;
			document.getElementById("totallost").innerHTML = total_lost;
		}
		
		insights()
                });
            });
        </script>
    </body>
</html>
